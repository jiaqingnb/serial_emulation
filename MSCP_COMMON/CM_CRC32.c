/**
@file CM_CRC32.c
@brief 计算32位CRC函数 
@author 小型化安全计算机平台开发小组
@version 1.0.0.0
@date 2017-12-20
*/
#include "CM_CRC32.h"

/*
*  功能描述： CRC32函数，计算过程如下，注意：计算CRC是从输入数据第一个字节的最高BIT开始的
*             采用的多项式0x4c11db7L，初始值为0x00000000,未镜像，结果异或系数为0x00000000
*             如果DataLen=0，返回值也为0.
*  参数说明： pData,    数据指针
*             DataLen,  数据长度（字节）
*  返回值：   返回值为CRC值
*/
UINT32 CM_Crc32(const UINT8 *pData,UINT32 DataLen)
{
    return Crc32(pData, DataLen);
}

/*
*  功能描述： BTM的CRC32函数，计算过程如下，注意：计算CRC是从输入数据第一个字节的最高BIT开始的
*             采用的多项式0x4c11db7L，初始值为0xFFFFFFFF,未镜像，结果异或系数为0x00000000
*             如果DataLen=0，返回值也为0.
*  参数说明： pData,    数据指针
*             DataLen,  数据长度（字节）
*  返回值：   返回值为CRC值
*/
UINT32 BTM_Crc32(const UINT8 *pData,UINT32 DataLen)
{
    UINT32 Crc;
    UINT32 i;


    /*生成多项式：0x4c11db7L;  */
    const static UINT32 CrcTable[256] = {
        0x00000000,0x04c11db7,0x09823b6e,0x0d4326d9,0x130476dc,0x17c56b6b,
        0x1a864db2,0x1e475005,0x2608edb8,0x22c9f00f,0x2f8ad6d6,0x2b4bcb61,
        0x350c9b64,0x31cd86d3,0x3c8ea00a,0x384fbdbd,0x4c11db70,0x48d0c6c7,
        0x4593e01e,0x4152fda9,0x5f15adac,0x5bd4b01b,0x569796c2,0x52568b75,
        0x6a1936c8,0x6ed82b7f,0x639b0da6,0x675a1011,0x791d4014,0x7ddc5da3,
        0x709f7b7a,0x745e66cd,0x9823b6e0U,0x9ce2ab57U,0x91a18d8eU,0x95609039U,
        0x8b27c03cU,0x8fe6dd8bU,0x82a5fb52U,0x8664e6e5U,0xbe2b5b58U,0xbaea46efU,
        0xb7a96036U,0xb3687d81U,0xad2f2d84U,0xa9ee3033U,0xa4ad16eaU,0xa06c0b5dU,
        0xd4326d90U,0xd0f37027U,0xddb056feU,0xd9714b49U,0xc7361b4cU,0xc3f706fbU,
        0xceb42022U,0xca753d95U,0xf23a8028U,0xf6fb9d9fU,0xfbb8bb46U,0xff79a6f1U,
        0xe13ef6f4U,0xe5ffeb43U,0xe8bccd9aU,0xec7dd02dU,0x34867077,0x30476dc0,
        0x3d044b19,0x39c556ae,0x278206ab,0x23431b1c,0x2e003dc5,0x2ac12072,
        0x128e9dcf,0x164f8078,0x1b0ca6a1,0x1fcdbb16,0x018aeb13,0x054bf6a4,
        0x0808d07d,0x0cc9cdca,0x7897ab07,0x7c56b6b0,0x71159069,0x75d48dde,
        0x6b93dddb,0x6f52c06c,0x6211e6b5,0x66d0fb02,0x5e9f46bf,0x5a5e5b08,
        0x571d7dd1,0x53dc6066,0x4d9b3063,0x495a2dd4,0x44190b0d,0x40d816ba,
        0xaca5c697U,0xa864db20U,0xa527fdf9U,0xa1e6e04eU,0xbfa1b04bU,0xbb60adfcU,
        0xb6238b25U,0xb2e29692U,0x8aad2b2fU,0x8e6c3698U,0x832f1041U,0x87ee0df6U,
        0x99a95df3U,0x9d684044U,0x902b669dU,0x94ea7b2aU,0xe0b41de7U,0xe4750050U,
        0xe9362689U,0xedf73b3eU,0xf3b06b3bU,0xf771768cU,0xfa325055U,0xfef34de2U,
        0xc6bcf05fU,0xc27dede8U,0xcf3ecb31U,0xcbffd686U,0xd5b88683U,0xd1799b34U,
        0xdc3abdedU,0xd8fba05aU,0x690ce0ee,0x6dcdfd59,0x608edb80,0x644fc637,
        0x7a089632,0x7ec98b85,0x738aad5c,0x774bb0eb,0x4f040d56,0x4bc510e1,
        0x46863638,0x42472b8f,0x5c007b8a,0x58c1663d,0x558240e4,0x51435d53,
        0x251d3b9e,0x21dc2629,0x2c9f00f0,0x285e1d47,0x36194d42,0x32d850f5,
        0x3f9b762c,0x3b5a6b9b,0x0315d626,0x07d4cb91,0x0a97ed48,0x0e56f0ff,
        0x1011a0fa,0x14d0bd4d,0x19939b94,0x1d528623,0xf12f560eU,0xf5ee4bb9U,
        0xf8ad6d60U,0xfc6c70d7U,0xe22b20d2U,0xe6ea3d65U,0xeba91bbcU,0xef68060bU,
        0xd727bbb6U,0xd3e6a601U,0xdea580d8U,0xda649d6fU,0xc423cd6aU,0xc0e2d0ddU,
        0xcda1f604U,0xc960ebb3U,0xbd3e8d7eU,0xb9ff90c9U,0xb4bcb610U,0xb07daba7U,
        0xae3afba2U,0xaafbe615U,0xa7b8c0ccU,0xa379dd7bU,0x9b3660c6U,0x9ff77d71U,
        0x92b45ba8U,0x9675461fU,0x8832161aU,0x8cf30badU,0x81b02d74U,0x857130c3U,
        0x5d8a9099,0x594b8d2e,0x5408abf7,0x50c9b640,0x4e8ee645,0x4a4ffbf2,
        0x470cdd2b,0x43cdc09c,0x7b827d21,0x7f436096,0x7200464f,0x76c15bf8,
        0x68860bfd,0x6c47164a,0x61043093,0x65c52d24,0x119b4be9,0x155a565e,
        0x18197087,0x1cd86d30,0x029f3d35,0x065e2082,0x0b1d065b,0x0fdc1bec,
        0x3793a651,0x3352bbe6,0x3e119d3f,0x3ad08088,0x2497d08d,0x2056cd3a,
        0x2d15ebe3,0x29d4f654,0xc5a92679U,0xc1683bceU,0xcc2b1d17U,0xc8ea00a0U,
        0xd6ad50a5U,0xd26c4d12U,0xdf2f6bcbU,0xdbee767cU,0xe3a1cbc1U,0xe760d676U,
        0xea23f0afU,0xeee2ed18U,0xf0a5bd1dU,0xf464a0aaU,0xf9278673U,0xfde69bc4U,
        0x89b8fd09U,0x8d79e0beU,0x803ac667U,0x84fbdbd0U,0x9abc8bd5U,0x9e7d9662U,
        0x933eb0bbU,0x97ffad0cU,0xafb010b1U,0xab710d06U,0xa6322bdfU,0xa2f33668U,
        0xbcb4666dU,0xb8757bdaU,0xb5365d03U,0xb1f740b4U
    };

    i = 0;
    Crc = 0xFFFFFFFFU;

    while( i < DataLen )
    {   
        Crc = (Crc<<8) ^ CrcTable[ (Crc>>24) ^ pData[i]  ] ;   
		i++;
    }
    return Crc;
}


/*
*  功能描述： BigFileCrc32函数，计算比较大的文件的CRC码
*  参数说明： pData,    数据指针
*            DataLen,  数据长度（字节）
*			 CrcNum 拆分校验的次数
*            CrcFlag校验是否完成标志
*            *CrcCode计算得到的CRC码 
*  返回值  ： 0x55校验完成;0xff未校验完成:0xaa校验出错
*  修改时间:2016-03-14  作者:任赟军 
*合并说明：由互联互通引入 add by qxt 20161210
*/
UINT8 CM_BigFileCrc32(const UINT8 *pData,UINT32 DataLen,UINT8 CrcNum,UINT32 *CrcCode)
{
	return BigFileCrc32(pData, DataLen, CrcNum, CrcCode);
}

/*************************************************************
*  功能描述： Crc32计算函数，使用CRC32查找表1
*  参数说明：
*             pData,    数据指针
*             DataLen,  数据长度（字节）
*  返回值：   返回值crc32Result为CRC值
*  说明：     为保障平台小型化系统处理的安全性增加该CRC算法
*             add by lmy 20180411
**************************************************************/
UINT32 CM_Crc32_1(const UINT8 *pData, UINT32 DataLen)
{
	return Crc32_1(pData, DataLen);
}

/*************************************************************
*  功能描述： Crc32函数，使用CRC32查找表2
*  参数说明：
*             pData,    数据指针
*             DataLen,  数据长度（字节）
*  返回值：   返回值crc32Result为CRC值
*  说明：     为保障平台小型化系统处理的安全性增加该CRC算法
*             add by lmy 20180411
**************************************************************/
UINT32 CM_Crc32_2(const UINT8 *pData, UINT32 DataLen)
{
    return Crc32_2(pData, DataLen);
}

/*************************************************************
*  功能描述： Crc32计算函数
*  参数说明：
*             pData,    	数据指针
*             DataLen,  	数据长度（字节）
*			  CRC32Table,	CRC32查找表
*  返回值：   返回值crc32Result为CRC值
*  说明：     为保障平台小型化系统处理的安全性增加该CRC算法,
*			  该函数与RSSP-I协议中的(RsspCommon.c)CRC_Compute_Crc函数功能相同，
*			  但是参数不一样，需要注意。
*             add by lmy 20180411
**************************************************************/
UINT32 CM_Crc32_common(const UINT8 *pData, UINT32 DataLen, const UINT32 *CRC32Table)
{
	return Crc32_common(pData, DataLen, CRC32Table);
}


/*************************************************************
*  功能描述： Crc32分片计算函数
*  参数说明：
*             pData,        数据指针
*             DataLen,      数据长度（字节）
*             CRC           上一次计算出的CRC值
*  返回值：   返回值：当前片计算出的CRC值
*  作者：      gh  2021-05-17
**************************************************************/
UINT32 Crc32Slice(UINT32 Crc,const UINT8 *pData,UINT32 DataLen)
{
    UINT32 i;


    /*生成多项式*/
    /*POLY：0x4c11db7L;  */
    const static UINT32 CrcTable[256] = {
        0x00000000,0x04c11db7,0x09823b6e,0x0d4326d9,0x130476dc,0x17c56b6b,
        0x1a864db2,0x1e475005,0x2608edb8,0x22c9f00f,0x2f8ad6d6,0x2b4bcb61,
        0x350c9b64,0x31cd86d3,0x3c8ea00a,0x384fbdbd,0x4c11db70,0x48d0c6c7,
        0x4593e01e,0x4152fda9,0x5f15adac,0x5bd4b01b,0x569796c2,0x52568b75,
        0x6a1936c8,0x6ed82b7f,0x639b0da6,0x675a1011,0x791d4014,0x7ddc5da3,
        0x709f7b7a,0x745e66cd,0x9823b6e0U,0x9ce2ab57U,0x91a18d8eU,0x95609039U,
        0x8b27c03cU,0x8fe6dd8bU,0x82a5fb52U,0x8664e6e5U,0xbe2b5b58U,0xbaea46efU,
        0xb7a96036U,0xb3687d81U,0xad2f2d84U,0xa9ee3033U,0xa4ad16eaU,0xa06c0b5dU,
        0xd4326d90U,0xd0f37027U,0xddb056feU,0xd9714b49U,0xc7361b4cU,0xc3f706fbU,
        0xceb42022U,0xca753d95U,0xf23a8028U,0xf6fb9d9fU,0xfbb8bb46U,0xff79a6f1U,
        0xe13ef6f4U,0xe5ffeb43U,0xe8bccd9aU,0xec7dd02dU,0x34867077,0x30476dc0,
        0x3d044b19,0x39c556ae,0x278206ab,0x23431b1c,0x2e003dc5,0x2ac12072,
        0x128e9dcf,0x164f8078,0x1b0ca6a1,0x1fcdbb16,0x018aeb13,0x054bf6a4,
        0x0808d07d,0x0cc9cdca,0x7897ab07,0x7c56b6b0,0x71159069,0x75d48dde,
        0x6b93dddb,0x6f52c06c,0x6211e6b5,0x66d0fb02,0x5e9f46bf,0x5a5e5b08,
        0x571d7dd1,0x53dc6066,0x4d9b3063,0x495a2dd4,0x44190b0d,0x40d816ba,
        0xaca5c697U,0xa864db20U,0xa527fdf9U,0xa1e6e04eU,0xbfa1b04bU,0xbb60adfcU,
        0xb6238b25U,0xb2e29692U,0x8aad2b2fU,0x8e6c3698U,0x832f1041U,0x87ee0df6U,
        0x99a95df3U,0x9d684044U,0x902b669dU,0x94ea7b2aU,0xe0b41de7U,0xe4750050U,
        0xe9362689U,0xedf73b3eU,0xf3b06b3bU,0xf771768cU,0xfa325055U,0xfef34de2U,
        0xc6bcf05fU,0xc27dede8U,0xcf3ecb31U,0xcbffd686U,0xd5b88683U,0xd1799b34U,
        0xdc3abdedU,0xd8fba05aU,0x690ce0ee,0x6dcdfd59,0x608edb80,0x644fc637,
        0x7a089632,0x7ec98b85,0x738aad5c,0x774bb0eb,0x4f040d56,0x4bc510e1,
        0x46863638,0x42472b8f,0x5c007b8a,0x58c1663d,0x558240e4,0x51435d53,
        0x251d3b9e,0x21dc2629,0x2c9f00f0,0x285e1d47,0x36194d42,0x32d850f5,
        0x3f9b762c,0x3b5a6b9b,0x0315d626,0x07d4cb91,0x0a97ed48,0x0e56f0ff,
        0x1011a0fa,0x14d0bd4d,0x19939b94,0x1d528623,0xf12f560eU,0xf5ee4bb9U,
        0xf8ad6d60U,0xfc6c70d7U,0xe22b20d2U,0xe6ea3d65U,0xeba91bbcU,0xef68060bU,
        0xd727bbb6U,0xd3e6a601U,0xdea580d8U,0xda649d6fU,0xc423cd6aU,0xc0e2d0ddU,
        0xcda1f604U,0xc960ebb3U,0xbd3e8d7eU,0xb9ff90c9U,0xb4bcb610U,0xb07daba7U,
        0xae3afba2U,0xaafbe615U,0xa7b8c0ccU,0xa379dd7bU,0x9b3660c6U,0x9ff77d71U,
        0x92b45ba8U,0x9675461fU,0x8832161aU,0x8cf30badU,0x81b02d74U,0x857130c3U,
        0x5d8a9099,0x594b8d2e,0x5408abf7,0x50c9b640,0x4e8ee645,0x4a4ffbf2,
        0x470cdd2b,0x43cdc09c,0x7b827d21,0x7f436096,0x7200464f,0x76c15bf8,
        0x68860bfd,0x6c47164a,0x61043093,0x65c52d24,0x119b4be9,0x155a565e,
        0x18197087,0x1cd86d30,0x029f3d35,0x065e2082,0x0b1d065b,0x0fdc1bec,
        0x3793a651,0x3352bbe6,0x3e119d3f,0x3ad08088,0x2497d08d,0x2056cd3a,
        0x2d15ebe3,0x29d4f654,0xc5a92679U,0xc1683bceU,0xcc2b1d17U,0xc8ea00a0U,
        0xd6ad50a5U,0xd26c4d12U,0xdf2f6bcbU,0xdbee767cU,0xe3a1cbc1U,0xe760d676U,
        0xea23f0afU,0xeee2ed18U,0xf0a5bd1dU,0xf464a0aaU,0xf9278673U,0xfde69bc4U,
        0x89b8fd09U,0x8d79e0beU,0x803ac667U,0x84fbdbd0U,0x9abc8bd5U,0x9e7d9662U,
        0x933eb0bbU,0x97ffad0cU,0xafb010b1U,0xab710d06U,0xa6322bdfU,0xa2f33668U,
        0xbcb4666dU,0xb8757bdaU,0xb5365d03U,0xb1f740b4U
    };

    i = 0;

    while( i < DataLen )
    {
        Crc = (Crc<<8) ^ CrcTable[ (UINT8)((Crc>>24) ^ pData[i])  ] ;
        i++;
    }
    return Crc;
}
